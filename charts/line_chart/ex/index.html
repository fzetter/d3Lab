<!DOCTYPE html>
<meta charset="utf-8">

<!-- STYLE -->
<!-- ***** -->
<style>

  body { font: 12px Arial; }

  path {
    stroke: steelblue;
    stroke-width: 2;
    fill: none;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
  }

</style>

<!-- BODY -->
<!-- **** -->
<body>

  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script> -->
  <script src="../js/d3.min.js"></script>

  <script>

    // SVG Config
    const margin = {left: 80, right: 100, top: 50, bottom: 100}
    const width = 530, height = 210

    const g = d3.select("body")
    	.append("svg")
    		.attr("width", width + margin.right + margin.left)
    		.attr("height", height + margin.top + margin.bottom)
    	.append("g")
    		.attr("transform", "translate(" + margin.left + ", " + margin.top + ")")

    // Scales
    const x = d3.scaleTime().range([0, width])
    const y = d3.scaleLinear().range([0, height])

    // Axis
    const xAxis = d3.axisBottom(x)
    const yAxis = d3.axisLeft(y).scale(y).ticks(5)
    const y_axis = g.append("g").attr("class", "y axis")
    const x_axis = g.append("g").attr("class", "x axis").attr("transform", "translate(0, " + height + ")")

    // Time Format
    const parseDate = d3.timeParse("%Y")
    const formatDate = d3.timeFormat("%Y")
    const bisectDate = d3.bisector(d => d.year).left

    // DATA
    // *****
    d3.json("https://raw.githubusercontent.com/gcastillo56/d3Lab/master/charts/line_chart/data/example.json").then(data => {

        const y_data = "value", x_data = "year"

        data.forEach(d => {
            d[x_data] = parseDate(d[x_data])
            d[y_data] = +d[y_data]
        })

        // Scale the range of the data
        x.domain(d3.extent(data, d => d[x_data]))
        y.domain([d3.max(data, d => d[y_data]), 765*1000])

        // Line Chart
        const valueline = d3.line()
            .x(d => x(d[x_data]))
            .y(d => y(d[y_data]))

        // Add the valueline path.
        g.append("path")
            .attr("class", "line")
            .attr("d", valueline(data))

        // Axis
        x_axis.call(xAxis)
        y_axis.call(yAxis)

        // Focus
        const focus = g.append("g").style("display", "none")

       // Append x line
        focus.append("line")
            .attr("class", "x")
            .attr("y1", 0)
            .attr("y2", height)
            .style("stroke", "blue")
            .style("stroke-dasharray", "3,3")
            .style("opacity", 0.5)

        // Append y line
        focus.append("line")
            .attr("class", "y")
            .attr("x1", width)
            .attr("x2", width)
            .style("stroke", "blue")
            .style("stroke-dasharray", "3,3")
            .style("opacity", 0.5)

        // Append circle at intersection
        focus.append("circle")
            .attr("class", "y")
            .attr("r", 4)
            .style("fill", "none")
            .style("stroke", "blue")

        // Append y-data at intersection
        focus.append("text")
            .attr("class", "y1")
            .attr("dx", 8)
            .attr("dy", "-.3em")

        // Append x-data at intersection
        focus.append("text")
            .attr("class", "y2")
            .attr("dx", 8)
            .attr("dy", "1em")

        // Capture mouse
        g.append("rect")
            .attr("width", width)
            .attr("height", height)
            .style("fill", "none")
            .style("pointer-events", "all")
            .on("mouseover", () => focus.style("display", null))
            .on("mouseout", () => focus.style("display", "none"))
            .on("mousemove", mousemove)

        function mousemove() {
              let x0 = x.invert(d3.mouse(this)[0])
              let i = bisectDate(data, x0, 1)
              let d0 = data[i - 1]
              let d1 = data[i]
              let d = x0 - d0[x_data] > d1[x_data] - x0 ? d1 : d0

              focus.select("circle.y").attr("transform", "translate(" + x(d[x_data]) + "," + y(d[y_data]) + ")")
              focus.select("text.y1").attr("transform", "translate(" + x(d[x_data]) + "," + y(d[y_data]) + ")").text(d[y_data])
              focus.select("text.y2").attr("transform", "translate(" + x(d[x_data]) + "," + y(d[y_data]) + ")").text(formatDate(d[x_data]))
              focus.select(".x").attr("transform", "translate(" + x(d[x_data]) + "," + y(d[y_data]) + ")").attr("y2", height - y(d[y_data]))
              focus.select(".y").attr("transform", "translate(" + width * -1 + "," + y(d[y_data]) + ")").attr("x2", width + width)
        }

    })


    </script>
</body>
